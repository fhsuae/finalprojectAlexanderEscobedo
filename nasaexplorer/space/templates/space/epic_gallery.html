{% extends "base.html" %}

{% block title %}EPIC Earth Gallery{% endblock %}

{% block content %}
<h1 class="mb-4">NASA EPIC Earth Image Gallery</h1>

{% if api_error %}
  <!-- Display API error messages -->
  <p class="alert alert-warning">{{ api_error }}</p>
{% endif %}

{% if images %}
<!-- Slideshow controls -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <button id="prevBtn" class="btn btn-secondary">Previous</button>
  <button id="playBtn" class="btn btn-success">Play</button>
  <button id="pauseBtn" class="btn btn-danger">Pause</button>
  <button id="nextBtn" class="btn btn-secondary">Next</button>
</div>

<!-- Slideshow display -->
<div id="slideshow-container" class="text-center mb-4">
  <img id="slideshow-img"
       src="{{ images.0.image }}"
       class="img-fluid rounded shadow"
       style="max-height: 500px;">
  <p id="caption" class="mt-2 text-muted">
    {{ images.0.caption }}<br>
    <small>{{ images.0.date_time }}</small>
  </p>

  {% if user.is_authenticated %}
  <!-- Add current slideshow image to favorites -->
  <form method="post" action="{% url 'space:add_favorite' %}">
    {% csrf_token %}
    <input type="hidden" name="image_id" value="{{ images.0.date_time|slugify }}">
    <input type="hidden" name="image_title" value="{{ images.0.caption }}">
    <input type="hidden" name="image_url" value="{{ images.0.image }}">
    <button type="submit" class="btn btn-primary">Add to Favorites</button>
  </form>
  {% endif %}
</div>

<hr>

<!-- Thumbnail grid of all images -->
<div class="row mt-4">
  {% for item in images %}
    <div class="col-md-3 mb-4">
      <div class="card h-100">
        <img src="{{ item.image }}" class="card-img-top thumb-img" alt="EPIC image">
        <div class="card-body">
          <p class="card-text">
            {{ item.caption|truncatechars:100 }}<br>
            <small>{{ item.date_time }}</small>
          </p>

          {% if user.is_authenticated %}
          <!-- Add image to favorites button -->
          <form method="post" action="{% url 'space:add_favorite' %}">
            {% csrf_token %}
            <input type="hidden" name="image_id" value="{{ item.date_time|slugify }}">
            <input type="hidden" name="image_title" value="{{ item.caption }}">
            <input type="hidden" name="image_url" value="{{ item.image }}">
            <button type="submit" class="btn btn-sm btn-outline-primary">Add to Favorites</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- Slideshow JavaScript controls -->
<script>
const images = [
  {% for item in images %}
    {
      url: "{{ item.image }}",
      caption: "{{ item.caption|escapejs }}",
      date_time: "{{ item.date_time|escapejs }}"
    },
  {% endfor %}
];

let index = 0;
let interval = null;

function showImage(i) {
  const img = document.getElementById("slideshow-img");
  const caption = document.getElementById("caption");

  img.src = images[i].url;
  caption.innerHTML = images[i].caption + "<br><small>" + images[i].date_time + "</small>";

  const favForm = document.querySelector("#slideshow-container form");
  if (favForm) {
    favForm.querySelector('input[name="image_id"]').value = images[i].date_time.replace(/\s+/g, '-').toLowerCase();
    favForm.querySelector('input[name="image_title"]').value = images[i].caption;
    favForm.querySelector('input[name="image_url"]').value = images[i].url;
  }
}

document.getElementById("nextBtn").onclick = function () {
  index = (index + 1) % images.length;
  showImage(index);
};

document.getElementById("prevBtn").onclick = function () {
  index = (index - 1 + images.length) % images.length;
  showImage(index);
};

document.getElementById("playBtn").onclick = function () {
  if (!interval) {
    interval = setInterval(() => {
      index = (index + 1) % images.length;
      showImage(index);
    }, 3000);
  }
};

document.getElementById("pauseBtn").onclick = function () {
  clearInterval(interval);
  interval = null;
};
</script>

{% endblock %}
